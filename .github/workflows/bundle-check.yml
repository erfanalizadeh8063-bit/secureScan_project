name: bundle-check

on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  bundle-check:
    name: bundle-check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache npm and node_modules
        uses: actions/cache@v4
        with:
          path: |
            secureScan_Front/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('secureScan_Front/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-

      - name: Install & build frontend
        working-directory: secureScan_Front
        env:
          VITE_API_BASE: ${{ secrets.BUNDLE_CHECK_BACKEND_URL }}
        run: |
          npm ci --no-audit --no-fund
          VITE_API_BASE="$VITE_API_BASE" npm run build

      - name: Verify dist contains backend URL (secret redacted)
        working-directory: secureScan_Front
        env:
          BACKEND_URL: ${{ secrets.BUNDLE_CHECK_BACKEND_URL }}
        run: |
          set -euo pipefail
          # Only echo scheme+host when showing which URL we look for
          REDACTED=$(echo "$BACKEND_URL" | sed -E 's|(https?://[^/]+).*|\1|')
          echo "Checking for backend URL in dist: ${REDACTED}"
          if ! grep -R --fixed-strings --quiet "$BACKEND_URL" dist; then
            echo "ERROR: backend URL not found in 'dist'" >&2
            ls -la dist || true
            echo "--- sample built files (first 10 lines each; secret redacted) ---" >&2
            for f in $(find dist -type f -name '*.js' -o -name '*.html' | head -n 10); do
              echo "---- $f ----" >&2
              sed -n '1,10p' "$f" | sed -E "s|${BACKEND_URL}|[REDACTED_BACKEND_URL]|g" >&2 || true
            done
            exit 1
          fi
          echo "Backend URL found in built bundles. (host: ${REDACTED})"

      - name: Upload dist on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-dist-${{ github.run_id }}
          path: secureScan_Front/dist
