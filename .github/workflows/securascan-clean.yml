name: SecuraScan CI (clean)

on:
  push:
    branches: [ beta/ready ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  BACKEND_PORT: 8080

jobs:
  security:
    name: Security checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run gitleaks (secret scan)
        uses: gitleaks/gitleaks-action@v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --verbose

      - name: Install cargo-audit
        run: cargo install cargo-audit || true

      - name: Run cargo-audit
        run: |
          cd secureScan_Back
          cargo audit || true

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build backend
        run: |
          cd secureScan_Back
          cargo build --release

      - name: Run backend tests
        run: |
          cd secureScan_Back
          cargo test --release

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build frontend
        run: |
          cd secureScan_Front
          npm ci
          if [ -z "$VITE_API_BASE" ]; then export VITE_API_BASE="https://securascan-back-dd57.onrender.com"; fi
          npm run build

  deploy:
    name: Auto Deploy to Render
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render Frontend Deploy
        if: success()
        env:
          RENDER_FRONTEND_DEPLOY_HOOK: ${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}
        run: |
          if [ -n "${RENDER_FRONTEND_DEPLOY_HOOK}" ]; then
            echo "üöÄ Triggering Frontend Deploy..."
            curl -fsS -X POST "${RENDER_FRONTEND_DEPLOY_HOOK}" || echo "‚ö†Ô∏è Frontend deploy hook failed"
          else
            echo "‚ö†Ô∏è No RENDER_FRONTEND_DEPLOY_HOOK provided"
          fi

      - name: Trigger Render Backend Deploy
        if: success()
        env:
          RENDER_BACKEND_DEPLOY_HOOK: ${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}
        run: |
          if [ -n "${RENDER_BACKEND_DEPLOY_HOOK}" ]; then
            echo "üöÄ Triggering Backend Deploy..."
            curl -fsS -X POST "${RENDER_BACKEND_DEPLOY_HOOK}" || echo "‚ö†Ô∏è Backend deploy hook failed"
          else
            echo "‚ö†Ô∏è No RENDER_BACKEND_DEPLOY_HOOK provided"
          fi

      - name: Poll Backend Health
        run: |
          if [ -z "${{ secrets.RENDER_BACKEND_URL }}" ]; then
            echo "‚ö†Ô∏è No backend URL provided, skipping health check"
            exit 0
          fi
          echo "‚è≥ Waiting for backend health check..."
          for i in $(seq 1 20); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_BACKEND_URL }}/healthz" || echo 000)
            echo "Attempt $i ‚Üí $CODE"
            [ "$CODE" = "200" ] && { echo "‚úÖ Backend healthy"; exit 0; }
            sleep 8
          done
          echo "‚ùå Backend failed health check" && exit 1

      - name: Poll Frontend Health
        run: |
          if [ -z "${{ secrets.RENDER_FRONTEND_URL }}" ]; then
            echo "‚ö†Ô∏è No frontend URL provided, skipping health check"
            exit 0
          fi
          echo "‚è≥ Waiting for frontend availability..."
          for i in $(seq 1 20); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_FRONTEND_URL }}" || echo 000)
            echo "Attempt $i ‚Üí $CODE"
            if [ "$CODE" = "200" ] || [ "$CODE" = "304" ]; then
              echo "‚úÖ Frontend is serving successfully"
              exit 0
            fi
            sleep 8
          done
          echo "‚ùå Frontend failed health check" && exit 1

      - name: Comment Deployment Result on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const backend = process.env.BACKEND_STATUS || 'unknown';
            const frontend = process.env.FRONTEND_STATUS || 'unknown';
            const body = `‚úÖ **SecuraScan Auto Deploy** completed.\n\nBackend: ${backend}\nFrontend: ${frontend}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })
